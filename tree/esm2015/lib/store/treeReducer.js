/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { TreeActionTypes } from './treeActions.service';
import { createFeatureSelector, createSelector } from '@ngrx/store';
/** @type {?} */
export const NEW_NODE_ID = 'ri-new-node-id';
/** @type {?} */
export const emptyTreeData = {
    nodes: {
        entities: {},
        previouslySelected: null,
        selected: null,
        rootNodes: [],
        expanded: [],
    },
    configuration: {
        isFullyLoaded: false
    }
};
/**
 * @param {?} state
 * @param {?=} treeId
 * @return {?}
 */
function copyState(state, treeId = null) {
    /** @type {?} */
    const newState = Object.assign({}, state);
    // todo: find better way to clone object
    if (treeId) {
        newState[treeId] = {
            nodes: {
                entities: Object.assign({}, state[treeId].nodes.entities),
                previouslySelected: state[treeId].nodes.previouslySelected,
                selected: state[treeId].nodes.selected,
                rootNodes: [...state[treeId].nodes.rootNodes],
                expanded: [...state[treeId].nodes.expanded],
            },
            configuration: Object.assign({}, state[treeId].configuration)
        };
    }
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function removeNode(state, action) {
    /** @type {?} */
    const newState = copyState(state, action.payload.treeId);
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const treeState = newState[treeId];
    /** @type {?} */
    const node = action.payload.node;
    /** @type {?} */
    const parentId = node.parentId;
    delete treeState.nodes.entities[node.id];
    if (parentId) {
        /** @type {?} */
        const parent = Object.assign({}, treeState.nodes.entities[parentId]);
        if (parent.children) {
            parent.children = parent.children.filter((id) => id !== node.id);
        }
        treeState.nodes.entities[parentId] = parent;
    }
    else {
        treeState.nodes.rootNodes = treeState.nodes.rootNodes.filter((id) => id !== node.id);
    }
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function loadNodes(state, action) {
    /** @type {?} */
    const newState = copyState(state, action.payload.treeId);
    /** @type {?} */
    let parent = null;
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const parentId = action.payload.id;
    if (parentId) {
        parent = newState[treeId].nodes.entities[parentId];
        parent.children = [];
    }
    else {
        newState[treeId].nodes.entities = {};
    }
    action.payload.nodes.forEach((nodeData) => {
        nodeData.treeId = treeId;
        if (parent) {
            parent.children.push(nodeData.id);
            nodeData.parents = [...parent.parents, ...[parent.id]];
        }
        else {
            nodeData.parents = [];
        }
        newState[treeId].nodes.entities[nodeData.id] = nodeData;
        if (!parentId) {
            newState[treeId].nodes.rootNodes.push(nodeData.id);
        }
    });
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function expandNode(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const newState = copyState(state, treeId);
    /** @type {?} */
    const nodeId = action.payload.id;
    // newState[treeId].nodes.entities[nodeId] = Object.assign({}, newState[treeId].nodes.entities[nodeId], {isExpanded: true});
    newState[treeId].nodes.expanded = [...newState[treeId].nodes.expanded, nodeId];
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function collapseNode(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const newState = copyState(state, treeId);
    /** @type {?} */
    const nodeId = action.payload.id;
    // newState[treeId].nodes.entities[nodeId] = {...newState[treeId].nodes.entities[nodeId], ...{isExpanded: false}};
    newState[treeId].nodes.expanded = newState[treeId].nodes.expanded.filter((id) => id !== nodeId);
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function insertNode(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const newState = copyState(state, treeId);
    /** @type {?} */
    const parentId = action.payload.parentId;
    /** @type {?} */
    const newNode = {
        id: NEW_NODE_ID,
        treeId: treeId,
        name: 'New data',
        parentId: parentId,
        children: [],
        parents: [],
        isExpanded: false
    };
    newState[treeId].nodes.entities[NEW_NODE_ID] = newNode;
    if (!parentId) {
        newState[treeId].nodes.rootNodes = [...newState[treeId].nodes.rootNodes, NEW_NODE_ID];
    }
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function saveNode(state, action) {
    /** @type {?} */
    const newState = copyState(state, action.payload.treeId);
    /** @type {?} */
    const old = action.payload.oldNode;
    /** @type {?} */
    const newNode = action.payload.node;
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const treeState = newState[treeId].nodes.entities;
    if (treeState[NEW_NODE_ID]) {
        delete treeState[NEW_NODE_ID];
    }
    else {
        delete treeState[old.id];
    }
    /** @type {?} */
    const nodeId = newNode.id;
    treeState[nodeId] = newNode;
    /** @type {?} */
    const parentId = newNode.parentId;
    /** @type {?} */
    const parent = treeState[parentId] || null;
    newNode.parents = [];
    if (parentId) {
        if (parent) {
            if (!parent.children) {
                parent.children = [];
            }
            parent.children.push(nodeId);
            newNode.parents = [...parent.parents, parent.id];
        }
    }
    else if (old.id === NEW_NODE_ID) {
        newState[treeId].nodes.rootNodes = newState[treeId].nodes.rootNodes.filter((id) => id !== NEW_NODE_ID);
        newState[treeId].nodes.rootNodes.push(nodeId);
    }
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function moveNode(state, action) {
    /** @type {?} */
    const newState = copyState(state, action.payload.treeId);
    /** @type {?} */
    const oldNode = action.payload.source;
    /** @type {?} */
    const newNode = action.payload.target;
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const treeData = newState[treeId];
    /** @type {?} */
    const treeState = newState[treeId].nodes.entities;
    // remove info about removed child
    if (oldNode.parentId) {
        treeState[oldNode.parentId].children = treeState[oldNode.parentId].children.filter((id) => id !== oldNode.id);
    }
    else {
        treeData.nodes.rootNodes = treeData.nodes.rootNodes.filter((id) => id !== oldNode.id);
    }
    // add info about moved node
    if (newNode.parentId) {
        /** @type {?} */
        const newParent = treeState[newNode.parentId];
        if (newParent.children) {
            newParent.children.push(newNode.id);
        }
        newNode.parents = [...newParent.parents, newParent.id];
    }
    else {
        treeData.nodes.rootNodes.push(newNode.id);
        newNode.parents = [];
    }
    // replace node data
    treeState[newNode.id] = Object.assign({}, newNode);
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function registerTree(state, action) {
    /** @type {?} */
    const newState = copyState(state);
    newState[action.payload.treeId] = {
        nodes: {
            entities: Object.assign({}, emptyTreeData.nodes.entities),
            previouslySelected: emptyTreeData.nodes.previouslySelected,
            selected: emptyTreeData.nodes.selected,
            rootNodes: [...emptyTreeData.nodes.rootNodes],
            expanded: [...emptyTreeData.nodes.expanded]
        },
        configuration: Object.assign({}, emptyTreeData.configuration)
    };
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function setAllNodes(state, action) {
    /** @type {?} */
    const newState = copyState(state, action.payload.treeId);
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const nodes = action.payload.nodes;
    /** @type {?} */
    const newNodes = {};
    /** @type {?} */
    const ids = nodes.map((nodeData) => nodeData.id);
    nodes.forEach((nodeData) => {
        nodeData.treeId = treeId;
        newNodes[nodeData.id] = nodeData;
        if (nodeData.parentId === null) {
            newState[treeId].nodes.rootNodes.push(nodeData.id);
        }
    });
    newState[treeId].nodes.rootNodes.forEach((id) => updateParents(newNodes, id));
    newState[treeId].nodes.entities = newNodes;
    return newState;
}
/**
 * @param {?} nodes
 * @param {?} nodeId
 * @param {?=} parents
 * @return {?}
 */
function updateParents(nodes, nodeId, parents = []) {
    /** @type {?} */
    const node = nodes[nodeId];
    if (node) {
        node.parents = [...parents];
        if (node.children.length > 0) {
            /** @type {?} */
            const newParents = [...parents, ...[node.id]];
            node.children.forEach(childId => updateParents(nodes, childId, newParents));
        }
    }
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function markTreeAsFullyLoaded(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const newState = copyState(state, treeId);
    newState[treeId].configuration = Object.assign({}, newState[treeId].configuration, { isFullyLoaded: true });
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function setConfiguration(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const newState = copyState(state, treeId);
    newState[treeId].configuration = Object.assign({}, newState[treeId].configuration, action.payload.configuration);
    return newState;
}
/**
 * @param {?} state
 * @param {?} action
 * @return {?}
 */
function selectNode(state, action) {
    /** @type {?} */
    const treeId = action.payload.treeId;
    /** @type {?} */
    const node = action.payload.node;
    /** @type {?} */
    const newState = copyState(state, treeId);
    newState[treeId].nodes.previouslySelected = newState[treeId].nodes.selected;
    newState[treeId].nodes.selected = node ? node.id : null;
    return newState;
}
/**
 * @param {?=} state
 * @param {?=} action
 * @return {?}
 */
export function treeReducer(state = {}, action) {
    switch (action.type) {
        case TreeActionTypes.TREE_REGISTER:
            return registerTree(state, action);
        case TreeActionTypes.TREE_SAVE_NODE_SUCCESS:
            return saveNode(state, action);
        case TreeActionTypes.TREE_DELETE_NODE_SUCCESS:
            return removeNode(state, action);
        case TreeActionTypes.TREE_INSERT_NODE:
            return insertNode(state, action);
        case TreeActionTypes.TREE_LOAD_SUCCESS:
            return loadNodes(state, action);
        case TreeActionTypes.TREE_MOVE_NODE_SUCCESS:
            return moveNode(state, action);
        case TreeActionTypes.TREE_SET_ALL_NODES:
            return setAllNodes(state, action);
        case TreeActionTypes.TREE_MARK_AS_FULLY_LOADED:
            return markTreeAsFullyLoaded(state, action);
        case TreeActionTypes.TREE_SET_CONFIGURATION:
            return setConfiguration(state, action);
        case TreeActionTypes.TREE_EXPAND_NODE:
            return expandNode(state, action);
        case TreeActionTypes.TREE_COLLAPSE_NODE:
            return collapseNode(state, action);
        case TreeActionTypes.TREE_SELECT_NODE:
            return selectNode(state, action);
        case TreeActionTypes.TREE_DELETE_NODE:
        case TreeActionTypes.TREE_EDIT_NODE_START:
        case TreeActionTypes.TREE_LOAD:
        case TreeActionTypes.TREE_MOVE_NODE:
        case TreeActionTypes.TREE_SAVE_NODE:
            return state;
        default:
            return state;
    }
}
/** @type {?} */
export const treeStateSelector = createFeatureSelector('trees');
/**
 * @param {?} treeId
 * @return {?}
 */
export function treeSelector(treeId) {
    return createSelector(treeStateSelector, (state) => state[treeId] || null);
}
/**
 * @param {?} treeId
 * @return {?}
 */
export function treeConfigurationSelector(treeId) {
    return createSelector(treeStateSelector, (state) => state[treeId].configuration || null);
}
/**
 * @param {?} treeId
 * @return {?}
 */
export function expandedNodesSelector(treeId) {
    return createSelector(treeStateSelector, (state) => state[treeId].nodes.expanded || []);
}
/**
 * @param {?} treeId
 * @return {?}
 */
export function selectedNodeSelector(treeId) {
    return createSelector(treeStateSelector, (state) => state[treeId].nodes.selected || null);
}
/**
 * @param {?} treeId
 * @return {?}
 */
export function previouslySelectedNodeSelector(treeId) {
    return createSelector(treeStateSelector, (state) => state[treeId].nodes.previouslySelected || null);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZVJlZHVjZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Acmlnbi9hbmd1bGFyMi10cmVlLyIsInNvdXJjZXMiOlsibGliL3N0b3JlL3RyZWVSZWR1Y2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBRUwsZUFBZSxFQWFoQixNQUFNLHVCQUF1QixDQUFDO0FBRS9CLE9BQU8sRUFBQyxxQkFBcUIsRUFBRSxjQUFjLEVBQUMsTUFBTSxhQUFhLENBQUM7O0FBR2xFLE1BQU0sT0FBTyxXQUFXLEdBQUcsZ0JBQWdCOztBQUUzQyxNQUFNLE9BQU8sYUFBYSxHQUFjO0lBQ3RDLEtBQUssRUFBRTtRQUNMLFFBQVEsRUFBRSxFQUFFO1FBQ1osa0JBQWtCLEVBQUUsSUFBSTtRQUN4QixRQUFRLEVBQUUsSUFBSTtRQUNkLFNBQVMsRUFBRSxFQUFFO1FBQ2IsUUFBUSxFQUFFLEVBQUU7S0FDYjtJQUNELGFBQWEsRUFBRTtRQUNiLGFBQWEsRUFBRSxLQUFLO0tBQ3JCO0NBQ0Y7Ozs7OztBQUVELFNBQVMsU0FBUyxDQUFDLEtBQWlCLEVBQUUsU0FBaUIsSUFBSTs7VUFDbkQsUUFBUSxxQkFBTyxLQUFLLENBQUM7SUFFM0Isd0NBQXdDO0lBQ3hDLElBQUksTUFBTSxFQUFFO1FBQ1YsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHO1lBQ2pCLEtBQUssRUFBRTtnQkFDTCxRQUFRLG9CQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO2dCQUMzQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLGtCQUFrQjtnQkFDMUQsUUFBUSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUTtnQkFDdEMsU0FBUyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztnQkFDN0MsUUFBUSxFQUFFLENBQUMs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Q0FBQyxpQkFBaUIsRUFBRSxDQUFDLEtBQWlCLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ3RHLENBQUM7Ozs7O0FBRUQsTUFBTSxVQUFVLG9CQUFvQixDQUFDLE1BQWM7SUFDakQsT0FBTyxjQUFjLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxLQUFpQixFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQztBQUN4RyxDQUFDOzs7OztBQUVELE1BQU0sVUFBVSw4QkFBOEIsQ0FBQyxNQUFjO0lBQzNELE9BQU8sY0FBYyxDQUFDLGlCQUFpQixFQUFFLENBQUMsS0FBaUIsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsQ0FBQztBQUNsSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJVHJlZUNvbmZpZ3VyYXRpb24sIElUcmVlRGF0YSwgSVRyZWVOb2RlcywgSVRyZWVTdGF0ZX0gZnJvbSAnLi9JVHJlZVN0YXRlJztcbmltcG9ydCB7XG4gIFRyZWVBY3Rpb24sXG4gIFRyZWVBY3Rpb25UeXBlcyxcbiAgVHJlZUNvbGxhcHNlTm9kZUFjdGlvbixcbiAgVHJlZURlbGV0ZU5vZGVTdWNjZXNzQWN0aW9uLFxuICBUcmVlRXhwYW5kTm9kZUFjdGlvbixcbiAgVHJlZUluc2VydE5vZGVBY3Rpb24sXG4gIFRyZWVMb2FkTm9kZXNTdWNjZXNzQWN0aW9uLFxuICBUcmVlTWFya0FzRnVsbHlMb2FkZWRBY3Rpb24sXG4gIFRyZWVNb3ZlTm9kZVN1Y2Nlc3NBY3Rpb24sXG4gIFRyZWVSZWdpc3RlckFjdGlvbixcbiAgVHJlZVNhdmVOb2RlU3VjY2Vzc0FjdGlvbixcbiAgVHJlZVNlbGVjdE5vZGVBY3Rpb24sXG4gIFRyZWVTZXRBbGxOb2Rlc0FjdGlvbixcbiAgVHJlZVNldENvbmZpZ3VyYXRpb25BY3Rpb25cbn0gZnJvbSAnLi90cmVlQWN0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7SU91dGVyTm9kZX0gZnJvbSAnLi4vaW50ZXJmYWNlcy9JT3V0ZXJOb2RlJztcbmltcG9ydCB7Y3JlYXRlRmVhdHVyZVNlbGVjdG9yLCBjcmVhdGVTZWxlY3Rvcn0gZnJvbSAnQG5ncngvc3RvcmUnO1xuaW1wb3J0IHtNZW1vaXplZFNlbGVjdG9yfSBmcm9tICdAbmdyeC9zdG9yZS9zcmMvc2VsZWN0b3InO1xuXG5leHBvcnQgY29uc3QgTkVXX05PREVfSUQgPSAncmktbmV3LW5vZGUtaWQnO1xuXG5leHBvcnQgY29uc3QgZW1wdHlUcmVlRGF0YTogSVRyZWVEYXRhID0ge1xuICBub2Rlczoge1xuICAgIGVudGl0aWVzOiB7fSxcbiAgICBwcmV2aW91c2x5U2VsZWN0ZWQ6IG51bGwsXG4gICAgc2VsZWN0ZWQ6IG51bGwsXG4gICAgcm9vdE5vZGVzOiBbXSxcbiAgICBleHBhbmRlZDogW10sXG4gIH0sXG4gIGNvbmZpZ3VyYXRpb246IHtcbiAgICBpc0Z1bGx5TG9hZGVkOiBmYWxzZVxuICB9XG59O1xuXG5mdW5jdGlvbiBjb3B5U3RhdGUoc3RhdGU6IElUcmVlU3RhdGUsIHRyZWVJZDogc3RyaW5nID0gbnVsbCkge1xuICBjb25zdCBuZXdTdGF0ZSA9IHsuLi5zdGF0ZX07XG5cbiAgLy8gdG9kbzogZmluZCBiZXR0ZXIgd2F5IHRvIGNsb25lIG9iamVjdFxuICBpZiAodHJlZUlkKSB7XG4gICAgbmV3U3RhdGVbdHJlZUlkXSA9IHtcbiAgICAgIG5vZGVzOiB7XG4gICAgICAgIGVudGl0aWVzOiB7Li4uc3RhdGVbdHJlZUlkXS5ub2Rlcy5lbnRpdGllc30sXG4gICAgICAgIHByZXZpb3VzbHlTZWxlY3RlZDogc3RhdGVbdHJlZUlkXS5ub2Rlcy5wcmV2aW91c2x5U2VsZWN0ZWQsXG4gICAgICAgIHNlbGVjdGVkOiBzdGF0ZVt0cmVlSWRdLm5vZGVzLnNlbGVjdGVkLFxuICAgICAgICByb290Tm9kZXM6IFsuLi5zdGF0ZVt0cmVlSWRdLm5vZGVzLnJvb3ROb2Rlc10sXG4gICAgICAgIGV4cGFuZGVkOiBbLi4uc3RhdGVbdHJlZUlkXS5ub2Rlcy5leHBhbmRlZF0sXG4gICAgICB9LFxuICAgICAgY29uZmlndXJhdGlvbjogey4uLnN0YXRlW3RyZWVJZF0uY29uZmlndXJhdGlvbn1cbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIG5ld1N0YXRlO1xufVxuXG5mdW5jdGlvbiByZW1vdmVOb2RlKHN0YXRlOiBJVHJlZVN0YXRlLCBhY3Rpb246IFRyZWVEZWxldGVOb2RlU3VjY2Vzc0FjdGlvbik6IElUcmVlU3RhdGUge1xuICBjb25zdCBuZXdTdGF0ZSA9IGNvcHlTdGF0ZShzdGF0ZSwgYWN0aW9uLnBheWxvYWQudHJlZUlkKTtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCB0cmVlU3RhdGUgPSBuZXdTdGF0ZVt0cmVlSWRdO1xuICBjb25zdCBub2RlID0gYWN0aW9uLnBheWxvYWQubm9kZTtcbiAgY29uc3QgcGFyZW50SWQgPSBub2RlLnBhcmVudElkO1xuXG4gIGRlbGV0ZSB0cmVlU3RhdGUubm9kZXMuZW50aXRpZXNbbm9kZS5pZF07XG5cbiAgaWYgKHBhcmVudElkKSB7XG4gICAgY29uc3QgcGFyZW50ID0gey4uLnRyZWVTdGF0ZS5ub2Rlcy5lbnRpdGllc1twYXJlbnRJZF19O1xuXG4gICAgaWYgKHBhcmVudC5jaGlsZHJlbikge1xuICAgICAgcGFyZW50LmNoaWxkcmVuID0gcGFyZW50LmNoaWxkcmVuLmZpbHRlcigoaWQpID0+IGlkICE9PSBub2RlLmlkKTtcbiAgICB9XG4gICAgdHJlZVN0YXRlLm5vZGVzLmVudGl0aWVzW3BhcmVudElkXSA9IHBhcmVudDtcbiAgfSBlbHNlIHtcbiAgICB0cmVlU3RhdGUubm9kZXMucm9vdE5vZGVzID0gdHJlZVN0YXRlLm5vZGVzLnJvb3ROb2Rlcy5maWx0ZXIoKGlkKSA9PiBpZCAhPT0gbm9kZS5pZCk7XG4gIH1cblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cblxuZnVuY3Rpb24gbG9hZE5vZGVzKHN0YXRlOiBJVHJlZVN0YXRlLCBhY3Rpb246IFRyZWVMb2FkTm9kZXNTdWNjZXNzQWN0aW9uKSB7XG4gIGNvbnN0IG5ld1N0YXRlID0gY29weVN0YXRlKHN0YXRlLCBhY3Rpb24ucGF5bG9hZC50cmVlSWQpO1xuICBsZXQgcGFyZW50OiBJT3V0ZXJOb2RlIHwgbnVsbCA9IG51bGw7XG4gIGNvbnN0IHRyZWVJZCA9IGFjdGlvbi5wYXlsb2FkLnRyZWVJZDtcbiAgY29uc3QgcGFyZW50SWQgPSBhY3Rpb24ucGF5bG9hZC5pZDtcblxuICBpZiAocGFyZW50SWQpIHtcbiAgICBwYXJlbnQgPSBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzW3BhcmVudElkXTtcbiAgICBwYXJlbnQuY2hpbGRyZW4gPSBbXTtcbiAgfSBlbHNlIHtcbiAgICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzID0ge307XG4gIH1cblxuICBhY3Rpb24ucGF5bG9hZC5ub2Rlcy5mb3JFYWNoKChub2RlRGF0YTogSU91dGVyTm9kZSkgPT4ge1xuICAgIG5vZGVEYXRhLnRyZWVJZCA9IHRyZWVJZDtcbiAgICBpZiAocGFyZW50KSB7XG4gICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlRGF0YS5pZCk7XG4gICAgICBub2RlRGF0YS5wYXJlbnRzID0gWy4uLnBhcmVudC5wYXJlbnRzLCAuLi5bcGFyZW50LmlkXV07XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGVEYXRhLnBhcmVudHMgPSBbXTtcbiAgICB9XG5cbiAgICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzW25vZGVEYXRhLmlkXSA9IG5vZGVEYXRhO1xuXG4gICAgaWYgKCFwYXJlbnRJZCkge1xuICAgICAgbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5yb290Tm9kZXMucHVzaChub2RlRGF0YS5pZCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cblxuZnVuY3Rpb24gZXhwYW5kTm9kZShzdGF0ZTogSVRyZWVTdGF0ZSwgYWN0aW9uOiBUcmVlRXhwYW5kTm9kZUFjdGlvbik6IElUcmVlU3RhdGUge1xuICBjb25zdCB0cmVlSWQgPSBhY3Rpb24ucGF5bG9hZC50cmVlSWQ7XG4gIGNvbnN0IG5ld1N0YXRlID0gY29weVN0YXRlKHN0YXRlLCB0cmVlSWQpO1xuICBjb25zdCBub2RlSWQgPSBhY3Rpb24ucGF5bG9hZC5pZDtcblxuICAvLyBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzW25vZGVJZF0gPSBPYmplY3QuYXNzaWduKHt9LCBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzW25vZGVJZF0sIHtpc0V4cGFuZGVkOiB0cnVlfSk7XG4gIG5ld1N0YXRlW3RyZWVJZF0ubm9kZXMuZXhwYW5kZWQgPSBbLi4ubmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5leHBhbmRlZCwgbm9kZUlkXTtcblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cblxuZnVuY3Rpb24gY29sbGFwc2VOb2RlKHN0YXRlOiBJVHJlZVN0YXRlLCBhY3Rpb246IFRyZWVDb2xsYXBzZU5vZGVBY3Rpb24pOiBJVHJlZVN0YXRlIHtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCBuZXdTdGF0ZSA9IGNvcHlTdGF0ZShzdGF0ZSwgdHJlZUlkKTtcbiAgY29uc3Qgbm9kZUlkID0gYWN0aW9uLnBheWxvYWQuaWQ7XG5cbiAgLy8gbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5lbnRpdGllc1tub2RlSWRdID0gey4uLm5ld1N0YXRlW3RyZWVJZF0ubm9kZXMuZW50aXRpZXNbbm9kZUlkXSwgLi4ue2lzRXhwYW5kZWQ6IGZhbHNlfX07XG4gIG5ld1N0YXRlW3RyZWVJZF0ubm9kZXMuZXhwYW5kZWQgPSBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmV4cGFuZGVkLmZpbHRlcigoaWQpID0+IGlkICE9PSBub2RlSWQpO1xuXG5cbiAgcmV0dXJuIG5ld1N0YXRlO1xufVxuXG5cbmZ1bmN0aW9uIGluc2VydE5vZGUoc3RhdGU6IElUcmVlU3RhdGUsIGFjdGlvbjogVHJlZUluc2VydE5vZGVBY3Rpb24pOiBJVHJlZVN0YXRlIHtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCBuZXdTdGF0ZSA9IGNvcHlTdGF0ZShzdGF0ZSwgdHJlZUlkKTtcbiAgY29uc3QgcGFyZW50SWQgPSBhY3Rpb24ucGF5bG9hZC5wYXJlbnRJZDtcbiAgY29uc3QgbmV3Tm9kZTogSU91dGVyTm9kZSA9IHtcbiAgICBpZDogTkVXX05PREVfSUQsXG4gICAgdHJlZUlkOiB0cmVlSWQsXG4gICAgbmFtZTogJ05ldyBkYXRhJyxcbiAgICBwYXJlbnRJZDogcGFyZW50SWQsXG4gICAgY2hpbGRyZW46IFtdLFxuICAgIHBhcmVudHM6IFtdLFxuICAgIGlzRXhwYW5kZWQ6IGZhbHNlXG4gIH07XG5cbiAgbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5lbnRpdGllc1tORVdfTk9ERV9JRF0gPSBuZXdOb2RlO1xuXG4gIGlmICghcGFyZW50SWQpIHtcbiAgICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnJvb3ROb2RlcyA9IFsuLi5uZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnJvb3ROb2RlcywgTkVXX05PREVfSURdO1xuICB9XG5cbiAgcmV0dXJuIG5ld1N0YXRlO1xufVxuXG5mdW5jdGlvbiBzYXZlTm9kZShzdGF0ZTogSVRyZWVTdGF0ZSwgYWN0aW9uOiBUcmVlU2F2ZU5vZGVTdWNjZXNzQWN0aW9uKTogSVRyZWVTdGF0ZSB7XG4gIGNvbnN0IG5ld1N0YXRlID0gY29weVN0YXRlKHN0YXRlLCBhY3Rpb24ucGF5bG9hZC50cmVlSWQpO1xuICBjb25zdCBvbGQgPSBhY3Rpb24ucGF5bG9hZC5vbGROb2RlO1xuICBjb25zdCBuZXdOb2RlID0gYWN0aW9uLnBheWxvYWQubm9kZTtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCB0cmVlU3RhdGUgPSBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzO1xuXG4gIGlmICh0cmVlU3RhdGVbTkVXX05PREVfSURdKSB7XG4gICAgZGVsZXRlIHRyZWVTdGF0ZVtORVdfTk9ERV9JRF07XG4gIH0gZWxzZSB7XG4gICAgZGVsZXRlIHRyZWVTdGF0ZVtvbGQuaWRdO1xuICB9XG5cbiAgY29uc3Qgbm9kZUlkID0gbmV3Tm9kZS5pZDtcbiAgdHJlZVN0YXRlW25vZGVJZF0gPSBuZXdOb2RlO1xuXG4gIGNvbnN0IHBhcmVudElkID0gbmV3Tm9kZS5wYXJlbnRJZDtcbiAgY29uc3QgcGFyZW50ID0gdHJlZVN0YXRlW3BhcmVudElkXSB8fCBudWxsO1xuXG4gIG5ld05vZGUucGFyZW50cyA9IFtdO1xuXG4gIGlmIChwYXJlbnRJZCkge1xuICAgIGlmIChwYXJlbnQpIHtcbiAgICAgIGlmICghcGFyZW50LmNoaWxkcmVuKSB7XG4gICAgICAgIHBhcmVudC5jaGlsZHJlbiA9IFtdO1xuICAgICAgfVxuXG4gICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlSWQpO1xuXG4gICAgICBuZXdOb2RlLnBhcmVudHMgPSBbLi4ucGFyZW50LnBhcmVudHMsIHBhcmVudC5pZF07XG4gICAgfVxuICB9IGVsc2UgaWYgKG9sZC5pZCA9PT0gTkVXX05PREVfSUQpIHtcbiAgICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnJvb3ROb2RlcyA9IG5ld1N0YXRlW3RyZWVJZF0ubm9kZXMucm9vdE5vZGVzLmZpbHRlcigoaWQpID0+IGlkICE9PSBORVdfTk9ERV9JRCk7XG4gICAgbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5yb290Tm9kZXMucHVzaChub2RlSWQpO1xuICB9XG5cbiAgcmV0dXJuIG5ld1N0YXRlO1xufVxuXG5mdW5jdGlvbiBtb3ZlTm9kZShzdGF0ZTogSVRyZWVTdGF0ZSwgYWN0aW9uOiBUcmVlTW92ZU5vZGVTdWNjZXNzQWN0aW9uKSB7XG4gIGNvbnN0IG5ld1N0YXRlID0gY29weVN0YXRlKHN0YXRlLCBhY3Rpb24ucGF5bG9hZC50cmVlSWQpO1xuICBjb25zdCBvbGROb2RlID0gYWN0aW9uLnBheWxvYWQuc291cmNlO1xuICBjb25zdCBuZXdOb2RlID0gYWN0aW9uLnBheWxvYWQudGFyZ2V0O1xuICBjb25zdCB0cmVlSWQgPSBhY3Rpb24ucGF5bG9hZC50cmVlSWQ7XG4gIGNvbnN0IHRyZWVEYXRhID0gbmV3U3RhdGVbdHJlZUlkXTtcbiAgY29uc3QgdHJlZVN0YXRlID0gbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5lbnRpdGllcztcblxuICAvLyByZW1vdmUgaW5mbyBhYm91dCByZW1vdmVkIGNoaWxkXG4gIGlmIChvbGROb2RlLnBhcmVudElkKSB7XG4gICAgdHJlZVN0YXRlW29sZE5vZGUucGFyZW50SWRdLmNoaWxkcmVuID0gdHJlZVN0YXRlW29sZE5vZGUucGFyZW50SWRdLmNoaWxkcmVuLmZpbHRlcigoaWQpID0+IGlkICE9PSBvbGROb2RlLmlkKTtcbiAgfSBlbHNlIHtcbiAgICB0cmVlRGF0YS5ub2Rlcy5yb290Tm9kZXMgPSB0cmVlRGF0YS5ub2Rlcy5yb290Tm9kZXMuZmlsdGVyKChpZCkgPT4gaWQgIT09IG9sZE5vZGUuaWQpO1xuICB9XG5cbiAgLy8gYWRkIGluZm8gYWJvdXQgbW92ZWQgbm9kZVxuICBpZiAobmV3Tm9kZS5wYXJlbnRJZCkge1xuICAgIGNvbnN0IG5ld1BhcmVudCA9IHRyZWVTdGF0ZVtuZXdOb2RlLnBhcmVudElkXTtcblxuICAgIGlmIChuZXdQYXJlbnQuY2hpbGRyZW4pIHtcbiAgICAgIG5ld1BhcmVudC5jaGlsZHJlbi5wdXNoKG5ld05vZGUuaWQpO1xuICAgIH1cblxuICAgIG5ld05vZGUucGFyZW50cyA9IFsuLi5uZXdQYXJlbnQucGFyZW50cywgbmV3UGFyZW50LmlkXTtcbiAgfSBlbHNlIHtcbiAgICB0cmVlRGF0YS5ub2Rlcy5yb290Tm9kZXMucHVzaChuZXdOb2RlLmlkKTtcbiAgICBuZXdOb2RlLnBhcmVudHMgPSBbXTtcbiAgfVxuXG4gIC8vIHJlcGxhY2Ugbm9kZSBkYXRhXG4gIHRyZWVTdGF0ZVtuZXdOb2RlLmlkXSA9IHsuLi5uZXdOb2RlfTtcblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVyVHJlZShzdGF0ZTogSVRyZWVTdGF0ZSwgYWN0aW9uOiBUcmVlUmVnaXN0ZXJBY3Rpb24pIHtcbiAgY29uc3QgbmV3U3RhdGUgPSBjb3B5U3RhdGUoc3RhdGUpO1xuXG4gIG5ld1N0YXRlW2FjdGlvbi5wYXlsb2FkLnRyZWVJZF0gPSB7XG4gICAgbm9kZXM6IHtcbiAgICAgIGVudGl0aWVzOiB7Li4uZW1wdHlUcmVlRGF0YS5ub2Rlcy5lbnRpdGllc30sXG4gICAgICBwcmV2aW91c2x5U2VsZWN0ZWQ6IGVtcHR5VHJlZURhdGEubm9kZXMucHJldmlvdXNseVNlbGVjdGVkLFxuICAgICAgc2VsZWN0ZWQ6IGVtcHR5VHJlZURhdGEubm9kZXMuc2VsZWN0ZWQsXG4gICAgICByb290Tm9kZXM6IFsuLi5lbXB0eVRyZWVEYXRhLm5vZGVzLnJvb3ROb2Rlc10sXG4gICAgICBleHBhbmRlZDogWy4uLmVtcHR5VHJlZURhdGEubm9kZXMuZXhwYW5kZWRdXG4gICAgfSxcbiAgICBjb25maWd1cmF0aW9uOiB7Li4uZW1wdHlUcmVlRGF0YS5jb25maWd1cmF0aW9ufVxuICB9O1xuXG4gIHJldHVybiBuZXdTdGF0ZTtcbn1cblxuXG5mdW5jdGlvbiBzZXRBbGxOb2RlcyhzdGF0ZTogSVRyZWVTdGF0ZSwgYWN0aW9uOiBUcmVlU2V0QWxsTm9kZXNBY3Rpb24pOiBJVHJlZVN0YXRlIHtcbiAgY29uc3QgbmV3U3RhdGUgPSBjb3B5U3RhdGUoc3RhdGUsIGFjdGlvbi5wYXlsb2FkLnRyZWVJZCk7XG4gIGNvbnN0IHRyZWVJZCA9IGFjdGlvbi5wYXlsb2FkLnRyZWVJZDtcbiAgY29uc3Qgbm9kZXMgPSBhY3Rpb24ucGF5bG9hZC5ub2RlcztcbiAgY29uc3QgbmV3Tm9kZXM6IElUcmVlTm9kZXMgPSB7fTtcbiAgY29uc3QgaWRzOiBzdHJpbmdbXSA9IG5vZGVzLm1hcCgobm9kZURhdGE6IElPdXRlck5vZGUpID0+IG5vZGVEYXRhLmlkKTtcblxuICBub2Rlcy5mb3JFYWNoKChub2RlRGF0YTogSU91dGVyTm9kZSkgPT4ge1xuICAgIG5vZGVEYXRhLnRyZWVJZCA9IHRyZWVJZDtcbiAgICBuZXdOb2Rlc1tub2RlRGF0YS5pZF0gPSBub2RlRGF0YTtcblxuICAgIGlmIChub2RlRGF0YS5wYXJlbnRJZCA9PT0gbnVsbCkge1xuICAgICAgbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5yb290Tm9kZXMucHVzaChub2RlRGF0YS5pZCk7XG4gICAgfVxuICB9KTtcblxuICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnJvb3ROb2Rlcy5mb3JFYWNoKChpZCkgPT4gdXBkYXRlUGFyZW50cyhuZXdOb2RlcywgaWQpKTtcblxuICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLmVudGl0aWVzID0gbmV3Tm9kZXM7XG5cbiAgcmV0dXJuIG5ld1N0YXRlO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVQYXJlbnRzKG5vZGVzOiBJVHJlZU5vZGVzLCBub2RlSWQ6IHN0cmluZywgcGFyZW50czogc3RyaW5nW10gPSBbXSk6IHZvaWQge1xuICBjb25zdCBub2RlOiBJT3V0ZXJOb2RlID0gbm9kZXNbbm9kZUlkXTtcblxuICBpZiAobm9kZSkge1xuICAgIG5vZGUucGFyZW50cyA9IFsuLi5wYXJlbnRzXTtcblxuICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IG5ld1BhcmVudHMgPSBbLi4ucGFyZW50cywgLi4uW25vZGUuaWRdXTtcblxuICAgICAgbm9kZS5jaGlsZHJlbi5mb3JFYWNoKGNoaWxkSWQgPT4gdXBkYXRlUGFyZW50cyhub2RlcywgY2hpbGRJZCwgbmV3UGFyZW50cykpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtYXJrVHJlZUFzRnVsbHlMb2FkZWQoc3RhdGU6IElUcmVlU3RhdGUsIGFjdGlvbjogVHJlZU1hcmtBc0Z1bGx5TG9hZGVkQWN0aW9uKTogSVRyZWVTdGF0ZSB7XG4gIGNvbnN0IHRyZWVJZCA9IGFjdGlvbi5wYXlsb2FkLnRyZWVJZDtcbiAgY29uc3QgbmV3U3RhdGUgPSBjb3B5U3RhdGUoc3RhdGUsIHRyZWVJZCk7XG5cbiAgbmV3U3RhdGVbdHJlZUlkXS5jb25maWd1cmF0aW9uID0gey4uLm5ld1N0YXRlW3RyZWVJZF0uY29uZmlndXJhdGlvbiwgLi4ue2lzRnVsbHlMb2FkZWQ6IHRydWV9fTtcblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cbmZ1bmN0aW9uIHNldENvbmZpZ3VyYXRpb24oc3RhdGU6IElUcmVlU3RhdGUsIGFjdGlvbjogVHJlZVNldENvbmZpZ3VyYXRpb25BY3Rpb24pOiBJVHJlZVN0YXRlIHtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCBuZXdTdGF0ZSA9IGNvcHlTdGF0ZShzdGF0ZSwgdHJlZUlkKTtcblxuICBuZXdTdGF0ZVt0cmVlSWRdLmNvbmZpZ3VyYXRpb24gPSB7Li4ubmV3U3RhdGVbdHJlZUlkXS5jb25maWd1cmF0aW9uLCAuLi5hY3Rpb24ucGF5bG9hZC5jb25maWd1cmF0aW9ufTtcblxuICByZXR1cm4gbmV3U3RhdGU7XG59XG5cbmZ1bmN0aW9uIHNlbGVjdE5vZGUoc3RhdGU6IElUcmVlU3RhdGUsIGFjdGlvbjogVHJlZVNlbGVjdE5vZGVBY3Rpb24pIHtcbiAgY29uc3QgdHJlZUlkID0gYWN0aW9uLnBheWxvYWQudHJlZUlkO1xuICBjb25zdCBub2RlID0gYWN0aW9uLnBheWxvYWQubm9kZTtcbiAgY29uc3QgbmV3U3RhdGUgPSBjb3B5U3RhdGUoc3RhdGUsIHRyZWVJZCk7XG5cbiAgbmV3U3RhdGVbdHJlZUlkXS5ub2Rlcy5wcmV2aW91c2x5U2VsZWN0ZWQgPSBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnNlbGVjdGVkO1xuICBuZXdTdGF0ZVt0cmVlSWRdLm5vZGVzLnNlbGVjdGVkID0gbm9kZSA/IG5vZGUuaWQgOiBudWxsO1xuXG4gIHJldHVybiBuZXdTdGF0ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyZWVSZWR1Y2VyKHN0YXRlOiBJVHJlZVN0YXRlID0ge30sIGFjdGlvbjogVHJlZUFjdGlvbik6IElUcmVlU3RhdGUge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9SRUdJU1RFUjpcbiAgICAgIHJldHVybiByZWdpc3RlclRyZWUoc3RhdGUsIGFjdGlvbik7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9TQVZFX05PREVfU1VDQ0VTUzpcbiAgICAgIHJldHVybiBzYXZlTm9kZShzdGF0ZSwgYWN0aW9uKTtcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX0RFTEVURV9OT0RFX1NVQ0NFU1M6XG4gICAgICByZXR1cm4gcmVtb3ZlTm9kZShzdGF0ZSwgYWN0aW9uKTtcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX0lOU0VSVF9OT0RFOlxuICAgICAgcmV0dXJuIGluc2VydE5vZGUoc3RhdGUsIGFjdGlvbik7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9MT0FEX1NVQ0NFU1M6XG4gICAgICByZXR1cm4gbG9hZE5vZGVzKHN0YXRlLCBhY3Rpb24pO1xuICAgIGNhc2UgVHJlZUFjdGlvblR5cGVzLlRSRUVfTU9WRV9OT0RFX1NVQ0NFU1M6XG4gICAgICByZXR1cm4gbW92ZU5vZGUoc3RhdGUsIGFjdGlvbik7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9TRVRfQUxMX05PREVTOlxuICAgICAgcmV0dXJuIHNldEFsbE5vZGVzKHN0YXRlLCBhY3Rpb24pO1xuICAgIGNhc2UgVHJlZUFjdGlvblR5cGVzLlRSRUVfTUFSS19BU19GVUxMWV9MT0FERUQ6XG4gICAgICByZXR1cm4gbWFya1RyZWVBc0Z1bGx5TG9hZGVkKHN0YXRlLCBhY3Rpb24pO1xuICAgIGNhc2UgVHJlZUFjdGlvblR5cGVzLlRSRUVfU0VUX0NPTkZJR1VSQVRJT046XG4gICAgICByZXR1cm4gc2V0Q29uZmlndXJhdGlvbihzdGF0ZSwgYWN0aW9uKTtcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX0VYUEFORF9OT0RFOlxuICAgICAgcmV0dXJuIGV4cGFuZE5vZGUoc3RhdGUsIGFjdGlvbik7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9DT0xMQVBTRV9OT0RFOlxuICAgICAgcmV0dXJuIGNvbGxhcHNlTm9kZShzdGF0ZSwgYWN0aW9uKTtcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX1NFTEVDVF9OT0RFOlxuICAgICAgcmV0dXJuIHNlbGVjdE5vZGUoc3RhdGUsIGFjdGlvbik7XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9ERUxFVEVfTk9ERTpcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX0VESVRfTk9ERV9TVEFSVDpcbiAgICBjYXNlIFRyZWVBY3Rpb25UeXBlcy5UUkVFX0xPQUQ6XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9NT1ZFX05PREU6XG4gICAgY2FzZSBUcmVlQWN0aW9uVHlwZXMuVFJFRV9TQVZFX05PREU6XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuXG59XG5cbmV4cG9ydCBjb25zdCB0cmVlU3RhdGVTZWxlY3RvcjogTWVtb2l6ZWRTZWxlY3RvcjxvYmplY3QsIElUcmVlU3RhdGU+ID0gY3JlYXRlRmVhdHVyZVNlbGVjdG9yPElUcmVlU3RhdGU+KCd0cmVlcycpO1xuXG5leHBvcnQgZnVuY3Rpb24gdHJlZVNlbGVjdG9yKHRyZWVJZDogc3RyaW5nKTogTWVtb2l6ZWRTZWxlY3RvcjxvYmplY3QsIElUcmVlRGF0YT4ge1xuICByZXR1cm4gY3JlYXRlU2VsZWN0b3IodHJlZVN0YXRlU2VsZWN0b3IsIChzdGF0ZTogSVRyZWVTdGF0ZSkgPT4gc3RhdGVbdHJlZUlkXSB8fCBudWxsKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyZWVDb25maWd1cmF0aW9uU2VsZWN0b3IodHJlZUlkOiBzdHJpbmcpOiBNZW1vaXplZFNlbGVjdG9yPG9iamVjdCwgSVRyZWVDb25maWd1cmF0aW9uPiB7XG4gIHJldHVybiBjcmVhdGVTZWxlY3Rvcih0cmVlU3RhdGVTZWxlY3RvciwgKHN0YXRlOiBJVHJlZVN0YXRlKSA9PiBzdGF0ZVt0cmVlSWRdLmNvbmZpZ3VyYXRpb24gfHwgbnVsbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRlZE5vZGVzU2VsZWN0b3IodHJlZUlkOiBzdHJpbmcpOiBNZW1vaXplZFNlbGVjdG9yPG9iamVjdCwgc3RyaW5nW10+IHtcbiAgcmV0dXJuIGNyZWF0ZVNlbGVjdG9yKHRyZWVTdGF0ZVNlbGVjdG9yLCAoc3RhdGU6IElUcmVlU3RhdGUpID0+IHN0YXRlW3RyZWVJZF0ubm9kZXMuZXhwYW5kZWQgfHwgW10pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0ZWROb2RlU2VsZWN0b3IodHJlZUlkOiBzdHJpbmcpOiBNZW1vaXplZFNlbGVjdG9yPG9iamVjdCwgc3RyaW5nPiB7XG4gIHJldHVybiBjcmVhdGVTZWxlY3Rvcih0cmVlU3RhdGVTZWxlY3RvciwgKHN0YXRlOiBJVHJlZVN0YXRlKSA9PiBzdGF0ZVt0cmVlSWRdLm5vZGVzLnNlbGVjdGVkIHx8IG51bGwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJldmlvdXNseVNlbGVjdGVkTm9kZVNlbGVjdG9yKHRyZWVJZDogc3RyaW5nKTogTWVtb2l6ZWRTZWxlY3RvcjxvYmplY3QsIHN0cmluZz4ge1xuICByZXR1cm4gY3JlYXRlU2VsZWN0b3IodHJlZVN0YXRlU2VsZWN0b3IsIChzdGF0ZTogSVRyZWVTdGF0ZSkgPT4gc3RhdGVbdHJlZUlkXS5ub2Rlcy5wcmV2aW91c2x5U2VsZWN0ZWQgfHwgbnVsbCk7XG59XG4iXX0=